### RFPV ###

### Pass variables like this ... 
# cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DGEOPSY_APP_BUILD_PATH=/tmp/geopsy ..
###

cmake_minimum_required(VERSION 3.9)

project(GpCoreTools VERSION 1.0.0 DESCRIPTION "GpCoreTools description")

### Modules
list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake")
list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules")
###

### Cxx options 
# With c++11
set(CMAKE_CXX_STANDARD 11)
# Warnings
if(MSVC)
  # Force to always compile with W4
  if(CMAKE_CXX_FLAGS MATCHES "/W[0-4]")
    string(REGEX REPLACE "/W[0-4]" "/W4" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
  else()
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /W4")
  endif()
elseif(CMAKE_COMPILER_IS_GNUCC OR CMAKE_COMPILER_IS_GNUCXX)
  # Update if necessary
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wno-long-long -Wdeprecated -pedantic")
endif()
###

# General build directory 
if(CMAKE_MODULAR_BUILD)
    # Global build
    set(THIS_REL_SRC "src")
    #message(STATUS "****** Modular (src: ${THIS_REL_SRC}) ******")
else()
    set(THIS_REL_SRC "geopsy-src/lib/GpCoreTools/src")
    #message(STATUS "****** Monolithic (src: ${THIS_REL_SRC}) ******")
endif()

# General build directory 
if(GEOPSY_APP_BUILD_PATH)
    # Global build
    set(THIS_BUILD_PATH ${GEOPSY_APP_BUILD_PATH})
else()
    set(THIS_BUILD_PATH ${CMAKE_BINARY_DIR})
endif()

# General bin directory 
if(GEOPSY_APP_BIN_PATH)
    # Global build
    set(THIS_BIN_PATH ${GEOPSY_APP_BIN_PATH})
else()
    set(THIS_BIN_PATH "${THIS_BUILD_PATH}/bin")
endif()

# General include directory 
if(GEOPSY_APP_INC_PATH)
    # Global build
    set(THIS_INC_PATH ${GEOPSY_APP_INC_PATH})
else()
    set(THIS_INC_PATH "${THIS_BUILD_PATH}/include")
endif()

# General library directory 
if(GEOPSY_APP_LIB_PATH)
    # Global build
    set(THIS_LIB_PATH ${GEOPSY_APP_LIB_PATH})
else()
    set(THIS_LIB_PATH "${THIS_BUILD_PATH}/lib")
endif()

#message(STATUS "THIS_BUILD_PATH: ${THIS_BUILD_PATH}")
#message(STATUS "THIS_BIN_PATH: ${THIS_BIN_PATH}")
#message(STATUS "THIS_INC_PATH: ${THIS_INC_PATH}")
#message(STATUS "THIS_LIB_PATH: ${THIS_LIB_PATH}")

### Add library directory to search path 
link_directories(${THIS_LIB_PATH})
###

### Add include directory to search path 
include_directories(${THIS_INC_PATH})
###

### Find packages
set(THREADS_PREFER_PTHREAD_FLAG ON)
# Find libpthread
find_package(Threads REQUIRED)
# Find librt
find_library(LIBRT rt REQUIRED)
#message(STATUS "librt found in ${LIBRT}")
###

# RFPV: bin and lib should created automatically
# Create include if not exists 
if(NOT EXISTS ${THIS_INC_PATH})
    file(MAKE_DIRECTORY ${THIS_INC_PATH})
    #add_custom_command(
        #TARGET ${PROJECT_NAME}
        #POST_BUILD    
        #file(MAKE_DIRECTORY ${THIS_INC_PATH})
    #)
endif()

# Create include/${PROJECT_NAME} if not exists 
if(NOT EXISTS ${THIS_INC_PATH}/${PROJECT_NAME})
    file(MAKE_DIRECTORY ${THIS_INC_PATH}/${PROJECT_NAME})
    #add_custom_command(
        #TARGET ${PROJECT_NAME}
        #POST_BUILD    
        #file(MAKE_DIRECTORY ${THIS_INC_PATH}/${PROJECT_NAME})
    #)
endif()

set(CPP_SRCS
    ${THIS_REL_SRC}/Address.cpp
    ${THIS_REL_SRC}/ApplicationHelp.cpp
    ${THIS_REL_SRC}/Average.cpp
    ${THIS_REL_SRC}/ByteOrder.cpp
    ${THIS_REL_SRC}/Chrono.cpp
    ${THIS_REL_SRC}/CoreApplication.cpp
    ${THIS_REL_SRC}/DaemonApplication.cpp
    ${THIS_REL_SRC}/DynamicBuffer.cpp
    ${THIS_REL_SRC}/Event.cpp
    ${THIS_REL_SRC}/EventLoop.cpp
    ${THIS_REL_SRC}/EventStream.cpp
    ${THIS_REL_SRC}/File.cpp
    ${THIS_REL_SRC}/FletcherChecksum.cpp
    ${THIS_REL_SRC}/GpCoreTools.cpp
    ${THIS_REL_SRC}/InfiniteLoop.cpp
    ${THIS_REL_SRC}/Leds.cpp
    ${THIS_REL_SRC}/LinearRegression.cpp
    ${THIS_REL_SRC}/Log.cpp
    ${THIS_REL_SRC}/MessageClassId.cpp
    ${THIS_REL_SRC}/MessageClassIdHeader.cpp
    ${THIS_REL_SRC}/MessageClassIdOnly.cpp
    ${THIS_REL_SRC}/MessageRaw.cpp
    ${THIS_REL_SRC}/MessageRawHeader.cpp
    ${THIS_REL_SRC}/MovingStatistics.cpp
    ${THIS_REL_SRC}/NewTimerEvent.cpp
    ${THIS_REL_SRC}/PackageInfo.cpp
    ${THIS_REL_SRC}/PThread.cpp
    ${THIS_REL_SRC}/ScreenClient.cpp
    ${THIS_REL_SRC}/Serial.cpp
    ${THIS_REL_SRC}/StaticTcpClient.cpp
    ${THIS_REL_SRC}/Statistics.cpp
    ${THIS_REL_SRC}/Stream.cpp
    ${THIS_REL_SRC}/TcpClientStream.cpp
    ${THIS_REL_SRC}/TcpServerStream.cpp
    ${THIS_REL_SRC}/Timer.cpp
    ${THIS_REL_SRC}/TraceBug.cpp
    ${THIS_REL_SRC}/Trace.cpp
    ${THIS_REL_SRC}/TraceInfo.cpp
    ${THIS_REL_SRC}/TraceStamp.cpp
    ${THIS_REL_SRC}/UdpServerStream.cpp
    ${THIS_REL_SRC}/UnixClientStream.cpp
    ${THIS_REL_SRC}/UnixServerStream.cpp
    ${THIS_REL_SRC}/Variant.cpp
)

# Headers got to include/*
set(HEA_INC
    ${THIS_REL_SRC}/GpCoreTools.h
)

# Headers got to include/GpCoreTools/*
set(HEA_SRCS
    ${THIS_REL_SRC}/Address.h
    ${THIS_REL_SRC}/ApplicationHelp.h
    ${THIS_REL_SRC}/Average.h
    ${THIS_REL_SRC}/ByteOrder.h
    ${THIS_REL_SRC}/Chrono.h
    ${THIS_REL_SRC}/CoreApplication.h
    ${THIS_REL_SRC}/DaemonApplication.h
    ${THIS_REL_SRC}/DynamicBuffer.h
    ${THIS_REL_SRC}/Event.h
    ${THIS_REL_SRC}/EventLoop.h
    ${THIS_REL_SRC}/EventStream.h
    ${THIS_REL_SRC}/File.h
    ${THIS_REL_SRC}/FletcherChecksum.h
    ${THIS_REL_SRC}/GpCoreToolsDLLExport.h
    ${THIS_REL_SRC}/GpCoreToolsInstallPath.h
    ${THIS_REL_SRC}/GpCoreToolsStatic.h
    ${THIS_REL_SRC}/GpCoreToolsVersion.h
    ${THIS_REL_SRC}/InfiniteLoop.h
    ${THIS_REL_SRC}/Leds.h
    ${THIS_REL_SRC}/LinearRegression.h
    ${THIS_REL_SRC}/Log.h
    ${THIS_REL_SRC}/MessageClassId.h
    ${THIS_REL_SRC}/MessageClassIdHeader.h
    ${THIS_REL_SRC}/MessageClassIdOnly.h
    ${THIS_REL_SRC}/MessageRaw.h
    ${THIS_REL_SRC}/MessageRawHeader.h
    ${THIS_REL_SRC}/MovingStatistics.h
    ${THIS_REL_SRC}/NewTimerEvent.h
    ${THIS_REL_SRC}/PackageInfo.h
    ${THIS_REL_SRC}/PThread.h
    ${THIS_REL_SRC}/ScreenClient.h
    ${THIS_REL_SRC}/Serial.h
    ${THIS_REL_SRC}/stable.h
    ${THIS_REL_SRC}/StaticTcpClient.h
    ${THIS_REL_SRC}/Statistics.h
    ${THIS_REL_SRC}/Stream.h
    ${THIS_REL_SRC}/TcpClientStream.h
    ${THIS_REL_SRC}/TcpServerStream.h
    ${THIS_REL_SRC}/Timer.h
    ${THIS_REL_SRC}/TraceBug.h
    ${THIS_REL_SRC}/Trace.h
    ${THIS_REL_SRC}/TraceInfo.h
    ${THIS_REL_SRC}/TraceStamp.h
    ${THIS_REL_SRC}/UdpServerStream.h
    ${THIS_REL_SRC}/UnixClientStream.h
    ${THIS_REL_SRC}/UnixServerStream.h
    ${THIS_REL_SRC}/Variant.h
)

# Include header files for compilation
include_directories(${THIS_REL_SRC})

### Set BUILD PATHS
# Set library build path 
set (EXECUTABLE_OUTPUT_PATH ${THIS_BIN_PATH})
# Set library build path 
set (LIBRARY_OUTPUT_PATH ${THIS_LIB_PATH})
### 

### Create shared library
add_library(${PROJECT_NAME} SHARED ${CPP_SRCS})
# Set VERSION
set_target_properties(${PROJECT_NAME} PROPERTIES VERSION ${PROJECT_VERSION})
# Set SOVERSION. Major version.
set_target_properties(${PROJECT_NAME} PROPERTIES SOVERSION 1)
# Link with libraries
target_link_libraries(${PROJECT_NAME} Threads::Threads)
target_link_libraries(${PROJECT_NAME} ${LIBRT})
### 

### POST BUILD
# Include headers (include/*)
foreach( file_i ${HEA_INC})
    add_custom_command(
        TARGET ${PROJECT_NAME}
        POST_BUILD
        COMMAND ${CMAKE_COMMAND}
        ARGS -E copy ${CMAKE_CURRENT_SOURCE_DIR}/${file_i} ${THIS_INC_PATH}
    )
endforeach( file_i )

# All other headers (include/${PROJECT_NAME}/*)
foreach( file_i ${HEA_SRCS})
    add_custom_command(
        TARGET ${PROJECT_NAME}
        POST_BUILD
        COMMAND ${CMAKE_COMMAND}
        ARGS -E copy ${CMAKE_CURRENT_SOURCE_DIR}/${file_i} ${THIS_INC_PATH}/${PROJECT_NAME}
    )
endforeach( file_i )
###

### Install actions 
## TODO: review this
# Install library
install(TARGETS ${PROJECT_NAME} DESTINATION lib/${PROJECT_NAME})

# Install library headers
file(GLOB HEADERS include/*.h)
install(FILES ${HEADERS} DESTINATION include/${PROJECT_NAME})
